(function(n){n.widget("mvc.datalist",{_create:function(){this.element.hasClass("datalist-input")&&(this._initOptions(),this._initFilters(),this._initAutocomplete(),this._initDatalistOpenSpan(),this._loadSelected(),this._cleanUp())},_initOptions:function(){var t=this.element,i=this.options;i.hiddenElement=n("#"+t.attr("data-datalist-hidden-input"))[0];i.recordsPerPage=t.attr("data-datalist-records-per-page");i.filters=t.attr("data-datalist-filters").split(",");i.sortColumn=t.attr("data-datalist-sort-column");i.sortOrder=t.attr("data-datalist-sort-order");i.title=t.attr("data-datalist-dialog-title");i.term=t.attr("data-datalist-term");i.page=parseInt(t.attr("data-datalist-page"));i.url=t.attr("data-datalist-url");t.addClass("mvc-datalist")},_initFilters:function(){for(i=0;i<this.options.filters.length;i++)this._initFilter(n("#"+this.options.filters[i]))},_initFilter:function(t){var i=this;i._on(t,{change:function(){var r=n.Event(i._select);i.options.filterChange&&i.options.filterChange(r,i.element[0],i.options.hiddenElement,t[0]);r.isDefaultPrevented()||i._select(null)}})},_initAutocomplete:function(){var t=this;this.element.autocomplete({source:function(i,r){n.ajax({url:t._formAutocompleteUrl(i.term),success:function(t){r(n.map(t.Rows,function(n){return{label:n.DatalistAcKey,value:n.DatalistAcKey,item:n}}))}})},select:function(n,i){t._select(i.item.item)},minLength:1});this.element.bind("keyup.datalist",function(){this.value.length==0&&t._select(null)});this.element.prevAll(".ui-helper-hidden-accessible").remove()},_initDatalistOpenSpan:function(){var r=this.element.nextAll(".datalist-open-span:first"),i,t;r.length!=0&&(i=n("#Datalist"),t=this,this._on(r,{click:function(){i.find(".datalist-search-input").unbind("keyup.datalist").bindWithDelay("keyup.datalist",function(){t.options.term=this.value;t.options.page=0;t._update(i)},500,!1).val(t.options.term);i.find(".datalist-items-per-page").spinner({change:function(){this.value=t._limitTo(this.value,1,99);t.options.recordsPerPage=this.value;t.options.page=0;t._update(i)}}).val(t._limitTo(t.options.recordsPerPage,1,99));i.find(".datalist-search-input").attr("placeholder",n.fn.datalist.lang.Search);i.find(".datalist-error-span").html(n.fn.datalist.lang.Error);i.dialog("option","title",t.options.title);i.find(".datalist-table-head").empty();i.find(".datalist-table-body").empty();i.dialog("open");t._update(i)}}))},_formAutocompleteUrl:function(n){return this.options.url+"?SearchTerm="+n+"&RecordsPerPage=20&SortOrder=Asc&Page=0"+this._formFiltersQuery()},_formDatalistUrl:function(n){return this.options.url+"?SearchTerm="+n+"&RecordsPerPage="+this.options.recordsPerPage+"&SortColumn="+this.options.sortColumn+"&SortOrder="+this.options.sortOrder+"&Page="+this.options.page+this._formFiltersQuery()},_formFiltersQuery:function(){var r="",t;for(i=0;i<this.options.filters.length;i++)t=n("#"+this.options.filters[i]),t.length==1&&(r+="&"+this.options.filters[i]+"="+t.val());return r},_defaultSelect:function(t){t?(n(this.options.hiddenElement).val(t.DatalistIdKey).change(),n(this.element).val(t.DatalistAcKey).change()):(n(this.element).val(null).change(),n(this.options.hiddenElement).val(null).change())},_loadSelected:function(){var t=this,i=n(t.options.hiddenElement).val();i&&n.ajax({url:t.options.url+"?Id="+i+"&RecordsPerPage=1",cache:!1,success:function(n){n.Rows.length>0&&t._select(n.Rows[0])}})},_select:function(t){var i=n.Event(this._defaultSelect);this.options.select&&this.options.select(i,this.element[0],this.options.hiddenElement,t);i.isDefaultPrevented()||this._defaultSelect(t)},_limitTo:function(n){return(n=parseInt(n),isNaN(n))?20:n<1?1:n>99?99:n},_cleanUp:function(){this.element.removeAttr("data-datalist-records-per-page");this.element.removeAttr("data-datalist-dialog-title");this.element.removeAttr("data-datalist-hidden-input");this.element.removeAttr("data-datalist-sort-column");this.element.removeAttr("data-datalist-sort-order");this.element.removeAttr("data-datalist-filters");this.element.removeAttr("data-datalist-term");this.element.removeAttr("data-datalist-page");this.element.removeAttr("data-datalist-url")},_update:function(t){var i=this,u=t.find(".datalist-search-input").val(),r;t.find(".datalist-error").fadeOut(300);r=setTimeout(function(){t.find(".datalist-processing").fadeIn(300);t.find(".datalist-data").fadeOut(300)},500);n.ajax({url:i._formDatalistUrl(u),cache:!1,success:function(n){i._updateHeader(t,n.Columns);i._updateData(t,n);i._updateNavbar(t,n.FilteredRecords);clearTimeout(r);t.find(".datalist-processing").fadeOut(300);t.find(".datalist-pager").fadeIn(300);t.find(".datalist-data").fadeIn(300)},error:function(){clearTimeout(r);t.find(".datalist-processing").fadeOut(300);t.find(".datalist-pager").fadeOut(300);t.find(".datalist-data").fadeOut(300);t.find(".datalist-error").fadeIn(300)}})},_updateHeader:function(t,i){var r=this,u="",f=0;n.each(i,function(n,t){u+='<th class="'+(t.CssClass!=null?t.CssClass:"")+'" data-column="'+t.Key+'">'+(t.Header!=null?t.Header:"");(r.options.sortColumn==t.Key||r.options.sortColumn==""&&f==0)&&(u+='<span class="datalist-sort-arrow glyphicon glyphicon-arrow-'+(r.options.sortOrder=="Asc"?"up":"down")+'"><\/span>',r.options.sortColumn=t.Key);u+="<\/th>";f++});t.find(".datalist-table-head").html("<tr>"+u+'<th class="datalist-select-header"><\/th><\/tr>');t.find(".datalist-table-head th").click(function(){var i=n(this);if(!i.attr("data-column"))return!1;r.options.sortOrder=r.options.sortColumn==i.attr("data-column")?r.options.sortOrder=="Asc"?"Desc":"Asc":"Asc";r.options.sortColumn=i.attr("data-column");r._update(t)})},_updateData:function(t,i){var f,u,e,o,r;if(i.Rows.length==0){t.find(".datalist-table-body").html('<tr><td colspan="0" style="text-align: center">'+n.fn.datalist.lang.NoDataFound+"<\/td><\/tr>");return}for(f="",r=0;r<i.Rows.length;r++)u="<tr>",e=i.Rows[r],n.each(i.Columns,function(n,t){u+='<td class="'+(t.CssClass!=null?t.CssClass:"")+'">'+(e[t.Key]!=null?e[t.Key]:"")+"<\/td>"}),u+='<td class="datalist-select-cell"><div class="datalist-select-container"><i class="glyphicon glyphicon-ok"><\/i><\/div><\/td><\/tr>',f+=u;for(t.find(".datalist-table-body").html(f),o=t.find("td.datalist-select-cell"),r=0;r<o.length;r++)this._bindSelect(t,o[r],i.Rows[r])},_updateNavbar:function(n,t){var i=this,u=n.find(".datalist-items-per-page").val(),r=parseInt(t/u)+1;t%u==0&&r--;r==0?n.find(".datalist-pager > .pagination").empty():n.find(".datalist-pager > .pagination").bootstrapPaginator({currentPage:i.options.page+1,bootstrapMajorVersion:3,totalPages:r,onPageChanged:function(t,r,u){i.options.page=u-1;i._update(n)},tooltipTitles:function(){return""},itemTexts:function(n,t){switch(n){case"first":return"&laquo;";case"prev":return"&lsaquo;";case"next":return"&rsaquo;";case"last":return"&raquo;";case"page":return t}}})},_bindSelect:function(n,t,i){var r=this;r._on(t,{click:function(){n.dialog("close");r._select(i)}})},_destroy:function(){var n=this.element,t=this.options;return n.attr("data-datalist-records-per-page",t.recordsPerPage),n.attr("data-datalist-hidden-input",t.hiddenElement.id),n.attr("data-datalist-filters",t.filters.join()),n.attr("data-datalist-sort-column",t.sortColumn),n.attr("data-datalist-sort-order",t.sortOrder),n.attr("data-datalist-dialog-title",t.title),n.attr("data-datalist-term",t.term),n.attr("data-datalist-page",t.page),n.attr("data-datalist-url",t.url),n.removeClass("mvc-datalist"),n.autocomplete("destroy"),this._super()}})})(jQuery),function(n){n.fn.datalist.lang={Error:"Error while retrieving records",NoDataFound:"No data found",Search:"Search..."};var t=n("#Datalist");t.find(".datalist-items-per-page").spinner({min:1,max:99});t.dialog({autoOpen:!1,minHeight:210,height:"auto",minWidth:455,width:"auto",modal:!0})}(jQuery);