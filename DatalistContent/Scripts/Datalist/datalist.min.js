/*!
 * Datalist 3.1.3
 * https://github.com/NonFactors/MVC.Datalist
 *
 * Copyright © 2014 NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(n){n.widget("mvc.datalist",{_create:function(){this.element.hasClass("datalist-input")&&(this._initOptions(),this._initFilters(),this._initAutocomplete(),this._initDatalistOpenSpan(),this._loadSelected(),this._cleanUp())},_initOptions:function(){var t=this.element,i=this.options;i.hiddenElement=n("#"+t.attr("data-datalist-hidden-input"))[0];i.recordsPerPage=t.attr("data-datalist-records-per-page");i.filters=t.attr("data-datalist-filters").split(",");i.sortColumn=t.attr("data-datalist-sort-column");i.sortOrder=t.attr("data-datalist-sort-order");i.page=parseInt(t.attr("data-datalist-page"));i.title=t.attr("data-datalist-dialog-title");i.term=t.attr("data-datalist-term");i.url=t.attr("data-datalist-url");t.addClass("mvc-datalist")},_initFilters:function(){for(i=0;i<this.options.filters.length;i++)this._initFilter(n("#"+this.options.filters[i]))},_initFilter:function(t){var i=this;i._on(t,{change:function(){var r=n.Event(i._select);i.options.filterChange&&i.options.filterChange(r,i.element[0],i.options.hiddenElement,t[0]);r.isDefaultPrevented()||i._select(null)}})},_initAutocomplete:function(){var t=this;this.element.autocomplete({source:function(i,r){n.ajax({url:t._formAutocompleteUrl(i.term),success:function(t){r(n.map(t.Rows,function(n){return{label:n.DatalistAcKey,value:n.DatalistAcKey,item:n}}))}})},select:function(n,i){t._select(i.item.item)},minLength:1});this.element.bind("keyup.datalist",function(){this.value.length==0&&t._select(null)});this.element.prevAll(".ui-helper-hidden-accessible").remove()},_initDatalistOpenSpan:function(){var r=this.element.nextAll(".datalist-open-span:first"),i,t;r.length!=0&&(i=n("#Datalist"),t=this,this._on(r,{click:function(){var r;i.find(".datalist-search-input").unbind("keyup.datalist").bind("keyup.datalist",null,function(){var n=this;clearTimeout(r);r=setTimeout(function(){t.options.term=n.value;t.options.page=0;t._update(i)},500)}).val(t.options.term);i.find(".datalist-items-per-page").spinner({change:function(){this.value=t._limitTo(this.value,1,99);t.options.recordsPerPage=this.value;t.options.page=0;t._update(i)}}).val(t._limitTo(t.options.recordsPerPage,1,99));i.find(".datalist-search-input").attr("placeholder",n.fn.datalist.lang.Search);i.find(".datalist-error-span").html(n.fn.datalist.lang.Error);i.dialog("option","title",t.options.title);i.find(".datalist-table-head").empty();i.find(".datalist-table-body").empty();t._update(i);setTimeout(function(){var n=i.dialog("open").parent();n.position({my:"center",at:"center",of:window});parseInt(n.css("left"))<0&&n.css("left",0);parseInt(n.css("top"))<0&&n.css("top",0)},100)}}))},_formAutocompleteUrl:function(n){return this.options.url+"?SearchTerm="+n+"&RecordsPerPage=20&SortOrder=Asc&Page=0"+this._formFiltersQuery()},_formDatalistUrl:function(n){return this.options.url+"?SearchTerm="+n+"&RecordsPerPage="+this.options.recordsPerPage+"&SortColumn="+this.options.sortColumn+"&SortOrder="+this.options.sortOrder+"&Page="+this.options.page+this._formFiltersQuery()},_formFiltersQuery:function(){var r="",t;for(i=0;i<this.options.filters.length;i++)t=n("#"+this.options.filters[i]),t.length==1&&(r+="&"+this.options.filters[i]+"="+t.val());return r},_defaultSelect:function(t){t?(n(this.options.hiddenElement).val(t.DatalistIdKey).change(),n(this.element).val(t.DatalistAcKey).change()):(n(this.element).val(null).change(),n(this.options.hiddenElement).val(null).change())},_loadSelected:function(){var t=this,i=n(t.options.hiddenElement).val();i&&n.ajax({url:t.options.url+"?Id="+i+"&RecordsPerPage=1",cache:!1,success:function(n){n.Rows.length>0&&t._select(n.Rows[0])}})},_select:function(t){var i=n.Event(this._defaultSelect);this.options.select&&this.options.select(i,this.element[0],this.options.hiddenElement,t);i.isDefaultPrevented()||this._defaultSelect(t)},_limitTo:function(n,t,i){return(n=parseInt(n),isNaN(n))?20:n<t?t:n>i?i:n},_cleanUp:function(){this.element.removeAttr("data-datalist-records-per-page");this.element.removeAttr("data-datalist-dialog-title");this.element.removeAttr("data-datalist-hidden-input");this.element.removeAttr("data-datalist-sort-column");this.element.removeAttr("data-datalist-sort-order");this.element.removeAttr("data-datalist-filters");this.element.removeAttr("data-datalist-term");this.element.removeAttr("data-datalist-page");this.element.removeAttr("data-datalist-url")},_update:function(t){var i=this,u=t.find(".datalist-search-input").val(),r=setTimeout(function(){t.find(".datalist-error-container").fadeOut(300);t.find(".datalist-processing").fadeIn(300);t.find(".datalist-pager").fadeOut(300);t.find(".datalist-data").fadeOut(300)},500);n.ajax({url:i._formDatalistUrl(u),cache:!1,success:function(n){i._updateHeader(t,n.Columns);i._updateData(t,n);i._updateNavbar(t,n.FilteredRecords);clearTimeout(r);t.find(".datalist-processing").fadeOut(300);t.find(".datalist-error-container").hide();t.find(".datalist-pager").fadeIn(300);t.find(".datalist-data").fadeIn(300)},error:function(){clearTimeout(r);t.find(".datalist-error-container").fadeIn(300);t.find(".datalist-processing").hide();t.find(".datalist-pager").hide();t.find(".datalist-data").hide()}})},_updateHeader:function(t,i){var r=this,u="",f=0;n.each(i,function(n,t){u+='<th class="'+(t.CssClass!=null?t.CssClass:"")+'" data-column="'+t.Key+'">'+(t.Header!=null?t.Header:"");r.options.sortColumn==t.Key||r.options.sortColumn==""&&f==0?(u+='<span class="datalist-sort-arrow glyphicon glyphicon-sort-by-attributes'+(r.options.sortOrder=="Asc"?"":"-alt")+'"><\/span>',r.options.sortColumn=t.Key):u+='<span class="datalist-sort-arrow"><\/span>';u+="<\/th>";f++});t.find(".datalist-table-head").html("<tr>"+u+'<th class="datalist-select-header"><\/th><\/tr>');t.find(".datalist-table-head th").click(function(){var i=n(this);if(!i.attr("data-column"))return!1;r.options.sortOrder=r.options.sortColumn==i.attr("data-column")?r.options.sortOrder=="Asc"?"Desc":"Asc":"Asc";r.options.sortColumn=i.attr("data-column");r._update(t)})},_updateData:function(t,i){var s,f,u,e,o,r;if(i.Rows.length==0){s=i.Columns?i.Columns.length+1:1;t.find(".datalist-table-body").html('<tr><td colspan="'+s+'" style="text-align: center">'+n.fn.datalist.lang.NoDataFound+"<\/td><\/tr>");return}for(f="",r=0;r<i.Rows.length;r++)u="<tr>",e=i.Rows[r],n.each(i.Columns,function(n,t){u+='<td class="'+(t.CssClass!=null?t.CssClass:"")+'">'+(e[t.Key]!=null?e[t.Key]:"")+"<\/td>"}),u+='<td class="datalist-select-cell"><div class="datalist-select-container"><i class="glyphicon glyphicon-ok"><\/i><\/div><\/td><\/tr>',f+=u;for(t.find(".datalist-table-body").html(f),o=t.find("td.datalist-select-cell"),r=0;r<o.length;r++)this._bindSelect(t,o[r],i.Rows[r])},_updateNavbar:function(n,t){var r=n.find(".datalist-items-per-page").val(),i=parseInt(t/r)+1;t%r==0&&i--;i==0?n.find(".datalist-pager > .pagination").empty():this._paginate(i)},_paginate:function(i){var o=Math.floor(this.options.page/5)*5,u=this.options.page,r=o,f="",s=this,e;for(i>5&&u>0&&(f='<li><a data-page="0">&laquo;<\/a><\/li><li><a data-page="'+(u-1)+'">&lsaquo;<\/a><\/li>');r<i&&r<o+5;)e="",r==this.options.page&&(e=' class="active"'),f+="<li"+e+'><a data-page="'+r+'">'+ ++r+"<\/a><\/li>";i>5&&u<i-1&&(f+='<li><a data-page="'+(u+1)+'">&rsaquo;<\/a><\/li><li><a data-page="'+(i-1)+'">&raquo;<\/a><\/li>');t.find(".datalist-pager > .pagination").html(f).find("li:not(.active) > a").click(function(){s.options.page=parseInt(n(this).data("page"));s._update(t)})},_bindSelect:function(n,t,i){var r=this;r._on(t,{click:function(){n.dialog("close");r._select(i)}})},_destroy:function(){var n=this.element,t=this.options;return n.attr("data-datalist-records-per-page",t.recordsPerPage),n.attr("data-datalist-hidden-input",t.hiddenElement.id),n.attr("data-datalist-filters",t.filters.join()),n.attr("data-datalist-sort-column",t.sortColumn),n.attr("data-datalist-sort-order",t.sortOrder),n.attr("data-datalist-dialog-title",t.title),n.attr("data-datalist-term",t.term),n.attr("data-datalist-page",t.page),n.attr("data-datalist-url",t.url),n.removeClass("mvc-datalist"),n.autocomplete("destroy"),this._super()}});n.fn.datalist.lang={Error:"Error while retrieving records",NoDataFound:"No data found",Search:"Search..."};var t=n("#Datalist");t.find(".datalist-items-per-page").spinner({min:1,max:99});t.dialog({autoOpen:!1,minHeight:210,height:"auto",minWidth:455,width:"auto",modal:!0})})(jQuery);