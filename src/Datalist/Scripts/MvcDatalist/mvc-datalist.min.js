/*!
 * Datalist 5.0.0
 * https://github.com/NonFactors/MVC5.Datalist
 *
 * Copyright Â© NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
var MvcDatalistFilter=function(){function n(n){this.page=n.attr("data-page");this.rows=n.attr("data-rows");this.sort=n.attr("data-sort");this.order=n.attr("data-order");this.search=n.attr("data-search");this.additionalFilters=n.attr("data-filters").split(",").filter(Boolean)}return n.prototype={getQuery:function(n){for(var u,r,t=$.extend({},this,n),f="?search="+encodeURIComponent(t.search)+"&sort="+encodeURIComponent(t.sort)+"&order="+encodeURIComponent(t.order)+"&rows="+encodeURIComponent(t.rows)+"&page="+encodeURIComponent(t.page)+(t.ids?t.ids:""),i=0;i<this.additionalFilters.length;i++)for(u=$('[name="'+this.additionalFilters[i]+'"]'),r=0;r<u.length;r++)f+="&"+encodeURIComponent(this.additionalFilters[i])+"="+encodeURIComponent(u[r].value);return f}},n}(),MvcDatalistDialog=function(){function n(n){this.datalist=n;this.filter=n.filter;this.instance=$("#Datalist");this.pager=this.instance.find("ul");this.table=this.instance.find("table");this.tableHead=this.instance.find("thead");this.tableBody=this.instance.find("tbody");this.title=n.element.attr("data-title");this.error=this.instance.find(".datalist-error");this.search=this.instance.find(".datalist-search");this.loader=this.instance.find(".datalist-loading");this.rows=this.instance.find(".datalist-rows input");this.selector=this.instance.find(".datalist-selector button");this.initOptions()}return n.prototype={set:function(n){n=n||{};$.extend(this.options.dialog,n.dialog);$.extend(this.options.spinner,n.spinner);$.extend(this.options.resizable,n.resizable)},initOptions:function(){var n=this;this.options={dialog:{classes:{"ui-dialog":"datalist-dialog"},dialogClass:"datalist-dialog",title:n.title,autoOpen:!1,minHeight:210,minWidth:455,width:"auto",modal:!0},spinner:{min:1,max:99,change:function(){this.value=n.limitRows(this.value);n.filter.rows=this.value;n.filter.page=0;n.refresh()}},resizable:{handles:"w,e",stop:function(){$(this).css("height","auto")}}}},open:function(){this.error.html(this.lang("Error"));this.search.val(this.filter.search);this.selected=this.datalist.selected.slice();this.rows.val(this.limitRows(this.filter.rows));this.search.attr("placeholder",this.lang("Search"));this.selector.parent().css("display",this.datalist.multi?"":"none");this.selector.text(this.lang("Select").replace("{0}",this.datalist.selected.length));this.bind();this.refresh();setTimeout(function(n){var t=n.dialog("open").parent();parseInt(t.css("left"))<0&&t.css("left",0);parseInt(t.css("top"))>100?t.css("top","100px"):parseInt(t.css("top"))<0&&t.css("top",0)},100,this.instance)},close:function(){this.instance.dialog("close")},refresh:function(){var n=this,t;this.error.fadeOut(300);t=setTimeout(function(n){n.loader.fadeIn(300);n.table.fadeOut(300);n.pager.fadeOut(300)},500,n);$.ajax({cache:!1,url:n.datalist.url+n.filter.getQuery()+n.selected.map(function(n){return"&selected="+n.DatalistIdKey}).join(""),success:function(i){clearTimeout(t);n.render(i)},error:function(){clearTimeout(t);n.render()}})},render:function(n){this.loader.fadeOut(300);this.tableHead.empty();this.tableBody.empty();this.pager.empty();n?(this.renderHeader(n.Columns),this.renderBody(n.Columns,n.Rows),this.renderFooter(n.FilteredRows),this.table.fadeIn(300),this.pager.fadeIn(300)):this.error.fadeIn(300)},renderHeader:function(n){for(var t=document.createElement("tr"),r=document.createElement("th"),i=0;i<n.length;i++)n[i].Hidden||t.appendChild(this.createHeaderColumn(n[i]));!this.filter.sort&&n.length>0&&(t.children[0].className+=" datalist-"+this.filter.order.toLowerCase());t.appendChild(r);this.tableHead.append(t)},renderBody:function(n,t){var u,i,f,s,r,e,o;for(t.length==0&&(u=this.createEmptyRow(n),u.children[0].innerHTML=this.lang("NoData"),u.className="datalist-empty",this.tableBody.append(u)),i=0;i<t.length;i++){for(f=this.createDataRow(t[i]),s=document.createElement("td"),r=0;r<n.length;r++)n[r].Hidden||(e=document.createElement("td"),e.className=n[r].CssClass||"",e.innerText=t[i][n[r].Key],f.appendChild(e));f.appendChild(s);this.tableBody.append(f);i==this.selected.length-1&&(o=this.createEmptyRow(n),o.className="datalist-split",this.tableBody.append(o))}},renderFooter:function(n){var t,r,i;if(this.totalRows=n+this.selected.length,t=Math.ceil(n/this.filter.rows),t>0){for(r=Math.floor(this.filter.page/5)*5,t>5&&this.filter.page>0&&(this.renderPage("&laquo",0),this.renderPage("&lsaquo;",this.filter.page-1)),i=r;i<t&&i<r+5;i++)this.renderPage(i+1,i);t>5&&this.filter.page<t-1&&(this.renderPage("&rsaquo;",this.filter.page+1),this.renderPage("&raquo;",t-1))}},createDataRow:function(n){var t=this,i=this.datalist,r=document.createElement("tr");t.indexOfSelected(n.DatalistIdKey)>=0&&(r.className="selected");$(r).on("click.datalist",function(){var r=t.indexOfSelected(n.DatalistIdKey);r>=0?(t.selected.splice(r,1),$(this).removeClass("selected")):(i.multi?t.selected.push(n):t.selected=[n],$(this).addClass("selected"));i.multi?t.selector.text(t.lang("Select").replace("{0}",t.selected.length)):(i.select(t.selected,!1),t.close())});return r},createEmptyRow:function(n){var t=document.createElement("tr"),i=document.createElement("td");return t.appendChild(i),i.setAttribute("colspan",n.length+1),t},createHeaderColumn:function(n){var i=document.createElement("th"),t,r;i.innerText=n.Header;t=this.filter;r=this;n.CssClass&&(i.className=n.CssClass);t.sort==n.Key&&(i.className+=" datalist-"+t.order.toLowerCase());$(i).on("click.datalist",function(){t.order=t.sort==n.Key?t.order=="Asc"?"Desc":"Asc":"Asc";t.sort=n.Key;r.refresh()});return i},renderPage:function(n,t){var r=document.createElement("span"),u=document.createElement("li"),i;if(u.appendChild(r),r.innerHTML=n,i=this,i.filter.page==t)u.className="active";else $(r).on("click.datalist",function(){var n=Math.ceil((i.totalRows-i.selected.length)/i.filter.rows);i.filter.page=t<n?t:n-1;i.refresh()});i.pager.append(u)},indexOfSelected:function(n){for(var t=0;t<this.selected.length;t++)if(this.selected[t].DatalistIdKey==n)return t;return-1},limitRows:function(n){var t=this.options.spinner;return Math.min(Math.max(parseInt(n),t.min),t.max)||this.filter.rows},lang:function(n){return $.fn.datalist.lang[n]},bind:function(){var t,n=this;n.instance.dialog(n.options.dialog);n.instance.dialog("option","close",function(){n.datalist.multi&&n.datalist.select(n.selected,!0)});n.instance.parent().resizable(n.options.resizable);n.search.off("keyup.datalist").on("keyup.datalist",function(i){if(i.keyCode<112||i.keyCode>126){var r=this;clearTimeout(t);t=setTimeout(function(){n.filter.search=r.value;n.filter.page=0;n.refresh()},500)}});n.rows.spinner(n.options.spinner);n.rows.off("keyup.datalist").on("keyup.datalist",function(n){n.which==13&&(this.blur(),this.focus())});n.selector.off("click").on("click",function(){n.close()})}},n}(),MvcDatalist=function(){function n(n,t){this.multi=n.attr("data-multi")=="true";this.filter=new MvcDatalistFilter(n);this.for=n.attr("data-for");this.url=n.attr("data-url");this.selected=[];this.element=n;this.hiddenElements=$('[name="'+this.for+'"]');this.browse=$('.datalist-browse[data-for="'+this.for+'"]');this.dialog=new MvcDatalistDialog(this);this.initOptions();this.set(t);this.reload(!1);this.cleanUp();this.bind()}return n.prototype={set:function(n){n=n||{};this.dialog.set(n);this.events=$.extend(this.events,n.events);this.element.autocomplete($.extend(this.options.autocomplete,n.autocomplete))},initOptions:function(){var n=this;this.options={autocomplete:{source:function(t,i){$.ajax({url:n.url+n.filter.getQuery({search:t.term,rows:20}),success:function(n){i($.map(n.rows,function(n){return{label:n.DatalistAcKey,value:n.DatalistAcKey,item:n}}))}})},select:function(t,i){n.select([i.item.item],!0);t.preventDefault()},minLength:1,delay:500}}},reload:function(n){var t=this,i=$.grep(t.hiddenElements.map(function(n,t){return encodeURIComponent(t.value)}).get(),Boolean);i.length>0?$.ajax({url:t.url+t.filter.getQuery({ids:"&ids="+i.join("&ids="),rows:i.length}),cache:!1,success:function(r){var f,u,e;if(r.Rows.length>0){for(f=[],u=0;u<r.Rows.length;u++)e=i.indexOf(r.Rows[u].DatalistIdKey),f[e]=r.Rows[u];t.select(f,n)}}}):t.select([],n)},select:function(n,t){if(this.events.select){var i=$.Event("select.datalist");if(this.events.select.apply(this,[i,n,t]),i.isDefaultPrevented())return}this.selected=n;this.multi&&this.hiddenElements.remove();n.length>0?this.multi?(this.element.val(n.map(function(n){return'"'+n.DatalistAcKey+'"'}).join(", ")),this.hiddenElements=this.createHiddenElements(n),this.element.before(this.hiddenElements)):(this.hiddenElements.val(n[0].DatalistIdKey),this.element.val(n[0].DatalistAcKey)):(this.hiddenElements.val(""),this.element.val(""));t&&(this.hiddenElements.change(),this.element.change())},createHiddenElements:function(n){for(var t,r=[],i=0;i<n.length;i++)t=document.createElement("input"),t.className="datalist-hidden-input",t.setAttribute("type","hidden"),t.setAttribute("name",this.for),t.value=n[i].DatalistIdKey,r[i]=t;return $(r)},cleanUp:function(){this.element.removeAttr("data-filters");this.element.removeAttr("data-search");this.element.removeAttr("data-multi");this.element.removeAttr("data-order");this.element.removeAttr("data-title");this.element.removeAttr("data-page");this.element.removeAttr("data-rows");this.element.removeAttr("data-sort");this.element.removeAttr("data-url")},bind:function(){var n=this,i,t;n.element.on("keyup.datalist",function(t){t.which!=9&&this.value.length==0&&n.hiddenElements.val()&&n.select([],!0)});n.browse.on("click.datalist",function(){n.element.is("[readonly]")||n.element.is("[disabled]")||n.dialog.open()});for(i=n.filter.additionalFilters,t=0;t<i.length;t++)$('[name="'+i[t]+'"]').on("change.datalist",function(t){n.events.filterChange&&n.events.filterChange.apply(n,[t]);t.isDefaultPrevented()||n.select([],!0)})}},n}();$.fn.datalist=function(n){return this.each(function(){$.data(this,"mvc-datalist")?n&&$.data(this,"mvc-datalist").set(n):$.data(this,"mvc-datalist",new MvcDatalist($(this),n))})};$.fn.datalist.lang={Error:"Error while retrieving records",NoData:"No data found",Select:"Select ({0})",Search:"Search..."};