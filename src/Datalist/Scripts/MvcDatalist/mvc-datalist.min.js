/*!
 * Datalist 6.0.0
 * https://github.com/NonFactors/MVC5.Datalist
 *
 * Copyright © NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
var MvcDatalistFilter=function(){function n(n){var t=n.group;this.datalist=n;this.sort=t.dataset.sort;this.order=t.dataset.order;this.search=t.dataset.search;this.page=parseInt(t.dataset.page);this.rows=parseInt(t.dataset.rows);this.additionalFilters=t.dataset.filters.split(",").filter(Boolean)}return n.prototype={formUrl:function(n){for(var f,u,o=this.datalist.url.split("?")[0],e=this.datalist.url.split("?")[1],i=this.datalist.extend({ids:[],checkIds:[],selected:[]},this,n),r="?"+(e?e+"&":"")+"search="+encodeURIComponent(i.search),t=0;t<this.additionalFilters.length;t++)for(f=document.querySelectorAll('[name="'+this.additionalFilters[t]+'"]'),u=0;u<f.length;u++)r+="&"+encodeURIComponent(this.additionalFilters[t])+"="+encodeURIComponent(f[u].value);for(t=0;t<i.selected.length;t++)r+="&selected="+encodeURIComponent(i.selected[t].DatalistIdKey);for(t=0;t<i.checkIds.length;t++)r+="&checkIds="+encodeURIComponent(i.checkIds[t].value);for(t=0;t<i.ids.length;t++)r+="&ids="+encodeURIComponent(i.ids[t].value);return r+="&sort="+encodeURIComponent(i.sort)+"&order="+encodeURIComponent(i.order)+"&rows="+encodeURIComponent(i.rows)+"&page="+encodeURIComponent(i.page)+"&_="+Date.now(),o+r}},n}(),MvcDatalistDialog=function(){function n(n){this.datalist=n;this.title=n.group.dataset.title;this.instance=document.getElementById(n.group.dataset.dialog);this.options={preserveSearch:!0,rows:{min:1,max:99},openDelay:100};this.overlay=new MvcDatalistOverlay(this);this.table=this.instance.querySelector("table");this.tableHead=this.instance.querySelector("thead");this.tableBody=this.instance.querySelector("tbody");this.rows=this.instance.querySelector(".datalist-rows");this.error=this.instance.querySelector(".datalist-error");this.pager=this.instance.querySelector(".datalist-pager");this.header=this.instance.querySelector(".datalist-title");this.search=this.instance.querySelector(".datalist-search");this.selector=this.instance.querySelector(".datalist-selector");this.closeButton=this.instance.querySelector(".datalist-close");this.loader=this.instance.querySelector(".datalist-dialog-loader")}return n.prototype={lang:{search:"Search...",select:"Select ({0})",noData:"No data found",error:"Error while retrieving records"},open:function(){var t=this,i=t.datalist.filter;n.prototype.current=this;t.error.style.display="none";t.loader.style.display="none";t.header.innerText=t.title;t.error.innerHTML=t.lang.error;t.selected=t.datalist.selected.slice();t.rows.value=t.limitRows(i.rows);t.search.setAttribute("placeholder",t.lang.search);i.search=t.options.preserveSearch?i.search:"";t.selector.style.display=t.datalist.multi?"":"none";t.selector.innerText=t.lang.select.replace("{0}",t.datalist.selected.length);t.bind();t.refresh();t.search.value=i.search;setTimeout(function(){t.loading&&(t.loader.style.opacity=1,t.loader.style.display="");t.overlay.show()},t.options.openDelay)},close:function(){var t=n.prototype.current;t.overlay.hide();t.datalist.multi&&(t.datalist.select(t.selected,!0),t.datalist.search.focus());n.prototype.current=null},refresh:function(){var n=this,t;n.loading=!0;n.error.style.opacity=0;n.error.style.display="";n.loader.style.display="";t=setTimeout(function(){n.loader.style.opacity=1},n.datalist.options.loadingDelay);n.datalist.load({selected:n.selected},function(i){n.loading=!1;clearTimeout(t);n.render(i)},function(){n.loading=!1;clearTimeout(t);n.render()})},render:function(n){var t=this;t.pager.innerHTML="";t.tableBody.innerHTML="";t.tableHead.innerHTML="";t.loader.style.opacity=0;setTimeout(function(){t.loader.style.display="none"},t.datalist.options.loadingDelay);n?(t.error.style.display="none",t.renderHeader(n.Columns),t.renderBody(n.Columns,n.Rows),t.renderFooter(n.FilteredRows)):t.error.style.opacity=1},renderHeader:function(n){for(var i=document.createElement("tr"),t=0;t<n.length;t++)n[t].Hidden||i.appendChild(this.createHeaderColumn(n[t]));i.appendChild(document.createElement("th"));this.tableHead.appendChild(i)},renderBody:function(n,t){var s,h,u,i,c,f,e,o,r;for(t.length||(r=document.createElement("td"),i=document.createElement("tr"),r.setAttribute("colspan",n.length+1),r.innerHTML=this.lang.noData,i.className="datalist-empty",this.tableBody.appendChild(i),i.appendChild(r)),s=!1,h=t.length&&this.datalist.indexOf(this.selected,t[0].DatalistIdKey)>=0,u=0;u<t.length;u++){for(i=this.createDataRow(t[u]),c=document.createElement("td"),f=0;f<n.length;f++)n[f].Hidden||(e=document.createElement("td"),e.className=n[f].CssClass||"",e.innerText=t[u][n[f].Key]||"",i.appendChild(e));i.appendChild(c);!s&&h&&this.datalist.indexOf(this.selected,t[u].DatalistIdKey)<0&&(o=document.createElement("tr"),r=document.createElement("td"),r.setAttribute("colspan",n.length+1),o.className="datalist-split",this.tableBody.appendChild(o),o.appendChild(r),s=!0);this.tableBody.appendChild(i)}},renderFooter:function(n){var t=this,i=t.datalist.filter,r=Math.ceil(n/i.rows),f,u;if(t.totalRows=n+t.selected.length,r){for(f=Math.floor(i.page/4)*4,i.page&&4<r&&(t.renderPage("&laquo",0),t.renderPage("&lsaquo;",i.page-1)),u=f;u<r&&u<f+4;u++)t.renderPage(u+1,u);4<r&&i.page<r-1&&(t.renderPage("&rsaquo;",i.page+1),t.renderPage("&raquo;",r-1))}else t.renderPage(1,0)},renderPage:function(n,t){var i=document.createElement("button"),r=this.datalist.filter,u=this;r.page==t&&(i.className="active");i.innerHTML=n;i.addEventListener("click",function(){if(r.page!=t){var n=Math.ceil((u.totalRows-u.selected.length)/r.rows)-1;r.page=Math.min(t,n);u.refresh()}});u.pager.appendChild(i)},createHeaderColumn:function(n){var i=document.createElement("th"),t=this.datalist.filter,r=this;return n.CssClass&&i.classList.add(n.CssClass),t.sort==n.Key&&i.classList.add("datalist-"+t.order.toLowerCase()),i.innerText=n.Header||"",i.addEventListener("click",function(){t.order=t.sort==n.Key&&t.order=="Asc"?"Desc":"Asc";t.sort=n.Key;r.refresh()}),i},createDataRow:function(n){var t=this,i=this.datalist,r=document.createElement("tr");return i.indexOf(t.selected,n.DatalistIdKey)>=0&&(r.className="selected"),r.addEventListener("click",function(){if(window.getSelection().isCollapsed){var r=i.indexOf(t.selected,n.DatalistIdKey);r>=0?i.multi&&(t.selected.splice(r,1),this.classList.remove("selected")):(i.multi?t.selected.push(n):t.selected=[n],this.classList.add("selected"));i.multi?t.selector.innerText=t.lang.select.replace("{0}",t.selected.length):(i.select(t.selected,!0),t.close(),i.search.focus())}}),r},limitRows:function(n){var t=this.options.rows;return Math.min(Math.max(parseInt(n),t.min),t.max)||this.datalist.filter.rows},bind:function(){this.search.removeEventListener("keyup",this.searchChanged);this.closeButton.removeEventListener("click",this.close);this.rows.removeEventListener("change",this.rowsChanged);this.selector.removeEventListener("click",this.close);this.search.addEventListener("keyup",this.searchChanged);this.closeButton.addEventListener("click",this.close);this.rows.addEventListener("change",this.rowsChanged);this.selector.addEventListener("click",this.close)},rowsChanged:function(){var t=n.prototype.current,i=t.limitRows(this.value);this.value=i;t.datalist.filter.rows!=i&&(t.datalist.filter.rows=i,t.datalist.filter.page=0,t.refresh())},searchChanged:function(t){var r=this,i=n.prototype.current;clearTimeout(i.searching);i.searching=setTimeout(function(){(i.datalist.filter.search!=r.value||t.keyCode==13)&&(i.datalist.filter.search=r.value,i.datalist.filter.page=0,i.refresh())},i.datalist.options.searchDelay)}},n}(),MvcDatalistOverlay=function(){function n(n){this.instance=this.getClosestOverlay(n.instance);this.dialog=n;this.bind()}return n.prototype={getClosestOverlay:function(n){for(var t=n;t.parentNode&&!t.classList.contains("datalist-overlay");)t=t.parentNode;if(t==document)throw new Error("Datalist dialog has to be inside a datalist-overlay.");return t},show:function(){var n=document.body.getBoundingClientRect(),t;n.left+n.right<window.innerWidth&&(t=parseFloat(getComputedStyle(document.body).paddingRight),document.body.style.paddingRight=t+17+"px");document.body.classList.add("datalist-open");this.instance.style.display="block"},hide:function(){document.body.classList.remove("datalist-open");document.body.style.paddingRight="";this.instance.style.display=""},bind:function(){this.instance.removeEventListener("click",this.onClick);this.instance.addEventListener("click",this.onClick)},onClick:function(n){var t=(n.target||n.srcElement).classList;(t.contains("datalist-overlay")||t.contains("datalist-wrapper"))&&MvcDatalistDialog.prototype.current.close()}},n}(),MvcDatalistAutocomplete=function(){function n(n){this.instance=document.createElement("ul");this.instance.className="datalist-autocomplete";this.options={minLength:1,rows:20};this.activeItem=null;this.datalist=n;this.items=[]}return n.prototype={search:function(n){var t=this,i=t.datalist;clearTimeout(t.searching);t.searching=setTimeout(function(){n.length<t.options.minLength||i.readonly||i.load({search:n,rows:t.options.rows},function(n){var r,u;for(t.clear(),n=n.Rows.filter(function(n){return!i.multi||i.indexOf(i.selected,n.DatalistIdKey)<0}),r=0;r<n.length;r++)u=document.createElement("li"),u.dataset.id=n[r].DatalistIdKey,u.innerText=n[r].DatalistAcKey,t.instance.appendChild(u),t.bind(u,[n[r]]),t.items.push(u);n.length?t.show():t.hide()})},t.datalist.options.searchDelay)},previous:function(){if(!this.instance.parentNode){this.search(this.datalist.search.value);return}this.activeItem?(this.activeItem.classList.remove("active"),this.activeItem=this.activeItem.previousSibling||this.items[this.items.length-1],this.activeItem.classList.add("active")):this.items.length&&(this.activeItem=this.items[this.items.length-1],this.activeItem.classList.add("active"))},next:function(){if(!this.instance.parentNode){this.search(this.datalist.search.value);return}this.activeItem?(this.activeItem.classList.remove("active"),this.activeItem=this.activeItem.nextSibling||this.items[0],this.activeItem.classList.add("active")):this.items.length&&(this.activeItem=this.items[0],this.activeItem.classList.add("active"))},clear:function(){this.items=[];this.activeItem=null;this.instance.innerHTML=""},show:function(){var n=this.datalist.search.getBoundingClientRect();this.instance.style.left=n.left+window.pageXOffset+"px";this.instance.style.top=n.top+n.height+window.pageYOffset+"px";document.body.appendChild(this.instance)},hide:function(){this.clear();this.instance.parentNode&&document.body.removeChild(this.instance)},bind:function(n,t){var i=this,r=i.datalist;n.addEventListener("mousedown",function(n){n.preventDefault()});n.addEventListener("click",function(n){n.preventDefault();r.multi?r.select(r.selected.concat(t),!0):r.select(t,!0);i.hide()});n.addEventListener("mouseenter",function(){i.activeItem&&i.activeItem.classList.remove("active");this.classList.add("active");i.activeItem=this})}},n}(),MvcDatalist=function(){function n(n,t){var i=this.closestGroup(n);if(i.dataset.id)return this.instances[parseInt(i.dataset.id)];this.items=[];this.events={};this.group=i;this.selected=[];this.for=i.dataset.for;this.url=i.dataset.url;this.multi=i.dataset.multi=="true";this.group.dataset.id=this.instances.length;this.readonly=i.dataset.readonly=="true";this.options={searchDelay:500,loadingDelay:300};this.search=i.querySelector(".datalist-input");this.browser=i.querySelector(".datalist-browser");this.control=i.querySelector(".datalist-control");this.valueContainer=i.querySelector(".datalist-values");this.values=this.valueContainer.querySelectorAll(".datalist-value");this.autocomplete=new MvcDatalistAutocomplete(this);this.filter=new MvcDatalistFilter(this);this.dialog=new MvcDatalistDialog(this);this.instances.push(this);this.set(t||{});this.reload(!1);this.cleanUp();this.bind()}return n.prototype={instances:[],closestGroup:function(n){for(var t=n;t.parentNode&&!t.classList.contains("datalist");)t=t.parentNode;if(t==document)throw new Error("Datalist can only be created from within datalist structure.");return t},extend:function(){for(var n,i={},t=0;t<arguments.length;t++)for(n in arguments[t])arguments[t].hasOwnProperty(n)&&(i[n]=Object.prototype.toString.call(i[n])=="[object Object]"?this.extend(i[n],arguments[t][n]):arguments[t][n]);return i},set:function(n){this.autocomplete.options=this.extend(this.autocomplete.options,n.autocomplete);this.setReadonly(n.readonly==null?this.readonly:n.readonly);this.dialog.options=this.extend(this.dialog.options,n.dialog);this.events=this.extend(this.events,n.events)},setReadonly:function(n){this.readonly=n;n?(this.search.setAttribute("tabindex",-1),this.search.setAttribute("readonly","readonly"),this.group.classList.add("datalist-readonly"),this.browser&&this.browser.setAttribute("tabindex",-1)):(this.search.removeAttribute("readonly"),this.search.removeAttribute("tabindex"),this.group.classList.remove("datalist-readonly"),this.browser&&this.browser.removeAttribute("tabindex"));this.resizeSearch()},load:function(n,t,i){var u=this,r;u.startLoading();r=new XMLHttpRequest;r.open("GET",u.filter.formUrl(n),!0);r.onload=function(){u.stopLoading();200<=r.status&&r.status<400?t(JSON.parse(r.responseText)):r.onerror()};r.onerror=function(){u.stopLoading();i&&i()};r.send()},browse:function(){this.readonly||this.dialog.open()},reload:function(n){var r=[],t=this,i=[].filter.call(t.values,function(n){return n.value});i.length?t.load({ids:i,rows:i.length},function(u){for(var e,f=0;f<i.length;f++)e=t.indexOf(u.Rows,i[f].value),e>=0&&r.push(u.Rows[e]);t.select(r,n)}):t.select(r,n)},select:function(n,t){var i=this,f,r,u;if(t=t==null||t,!i.events.select||(f=new CustomEvent("select",{cancelable:!0}),i.events.select.apply(i,[f,n,t]),!f.defaultPrevented)){if(t&&n.length==i.selected.length)for(t=!1,r=0;r<n.length&&!t;r++)t=n[r].DatalistIdKey!=i.selected[r].DatalistIdKey;i.selected=n;i.multi?(i.search.value="",i.valueContainer.innerHTML="",i.items.forEach(function(n){n.parentNode.removeChild(n)}),i.items=i.createSelectedItems(n),i.items.forEach(function(n){i.control.insertBefore(n,i.search)}),i.values=i.createValues(n),i.values.forEach(function(n){i.valueContainer.appendChild(n)}),i.resizeSearch()):n.length?(i.values[0].value=n[0].DatalistIdKey,i.search.value=n[0].DatalistAcKey):(i.values[0].value="",i.search.value="");t&&(typeof Event=="function"?u=new Event("change"):(u=document.createEvent("Event"),u.initEvent("change",!0,!0)),i.search.dispatchEvent(u),[].forEach.call(i.values,function(n){n.dispatchEvent(u)}))}},selectFirst:function(n){var t=this;t.load({rows:1},function(i){t.select(i.Rows,n)})},selectSingle:function(n){var t=this;t.load({rows:2},function(i){i.Rows.length==1?t.select(i.Rows,n):t.select([],n)})},createSelectedItems:function(n){for(var t,i,u=[],r=0;r<n.length;r++)t=document.createElement("button"),t.className="datalist-deselect",t.innerText="×",i=document.createElement("div"),i.innerText=n[r].DatalistAcKey||"",i.className="datalist-item",i.appendChild(t),u.push(i),this.bindDeselect(t,n[r].DatalistIdKey);return u},createValues:function(n){for(var t,r=[],i=0;i<n.length;i++)t=document.createElement("input"),t.className="datalist-value",t.setAttribute("type","hidden"),t.setAttribute("name",this.for),t.value=n[i].DatalistIdKey,r.push(t);return r},startLoading:function(){this.stopLoading();this.loading=setTimeout(function(n){n.search.classList.add("datalist-loading")},this.options.loadingDelay,this)},stopLoading:function(){clearTimeout(this.loading);this.search.classList.remove("datalist-loading")},bindDeselect:function(n,t){var i=this;n.addEventListener("click",function(){i.select(i.selected.filter(function(n){return n.DatalistIdKey!=t}),!0);i.search.focus()})},indexOf:function(n,t){for(var i=0;i<n.length;i++)if(n[i].DatalistIdKey==t)return i;return-1},resizeSearch:function(){var t;if(this.items.length){var n=getComputedStyle(this.control),i=this.control.clientWidth,r=this.items[this.items.length-1];i-=parseFloat(n.paddingLeft)+parseFloat(n.paddingRight);t=Math.floor(i-r.offsetLeft-r.offsetWidth);t>i/3?(n=getComputedStyle(this.search),t-=parseFloat(n.marginLeft)+parseFloat(n.marginRight)+4,this.search.style.width=t+"px"):this.search.style.width=""}else this.search.style.width=""},cleanUp:function(){delete this.group.dataset.readonly;delete this.group.dataset.filters;delete this.group.dataset.dialog;delete this.group.dataset.search;delete this.group.dataset.multi;delete this.group.dataset.order;delete this.group.dataset.title;delete this.group.dataset.page;delete this.group.dataset.rows;delete this.group.dataset.sort;delete this.group.dataset.url},bind:function(){var n=this,t,r,i;for(window.addEventListener("resize",function(){n.resizeSearch()}),n.search.addEventListener("focusin",function(){n.group.classList.add("datalist-focus")}),n.search.addEventListener("focusout",function(){n.group.classList.remove("datalist-focus")}),n.search.addEventListener("keydown",function(t){var i;t.which==8&&!this.value.length&&n.selected.length?n.select(n.selected.slice(0,-1),!0):t.which==38?(n.autocomplete.previous(),t.preventDefault()):t.which==40?(n.autocomplete.next(),t.preventDefault()):t.which==13&&n.autocomplete.activeItem&&(typeof Event=="function"?i=new Event("click"):(i=document.createEvent("Event"),i.initEvent("click",!0,!0)),n.autocomplete.activeItem.dispatchEvent(i),t.preventDefault())}),n.search.addEventListener("keyup",function(t){t.which==9||this.value.length||n.multi||!n.selected.length||(n.autocomplete.hide(),n.select([],!0))}),n.search.addEventListener("input",function(){n.autocomplete.search(this.value)}),n.search.addEventListener("blur",function(){this.value=!n.multi&&n.selected.length?n.selected[0].DatalistAcKey:"";n.autocomplete.hide()}),n.browser&&n.browser.addEventListener("click",function(t){t.preventDefault();n.browse()}),t=0;t<n.filter.additionalFilters.length;t++)for(r=document.querySelectorAll('[name="'+n.filter.additionalFilters[t]+'"]'),i=0;i<r.length;i++)r[i].addEventListener("change",function(t){if(n.events.filterChange&&n.events.filterChange.apply(n,[t]),!t.defaultPrevented&&n.selected.length){var r=[],i=[].filter.call(n.values,function(n){return n.value});n.load({checkIds:i,rows:i.length},function(t){for(var f,u=0;u<i.length;u++)f=n.indexOf(t.Rows,i[u].value),f>=0&&r.push(t.Rows[f]);n.select(r,!0)},function(){n.select(r,!0)})}})}},n}();